<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<link href='http://www.dpaxinos.com/feed.xml' rel='alternate' type='application/atom+xml'>

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <!-- <link href='http://fonts.googleapis.com/css?family=Fjalla+One|Cuprum:400,400italic|Maven+Pro' rel='stylesheet' type='text/css'> -->
<link href='http://fonts.googleapis.com/css?family=Lekton|Cabin|Yanone+Kaffeesatz:300|Oxygen|Fjalla+One|Cuprum:400,400italic|Maven+Pro|Arapey|Homenaje|Orbitron:900' rel='stylesheet' type='text/css'>
  <!--   <link href='http://fonts.googleapis.com/css?family=Abel|PT+Sans+Narrow:400,700|Quicksand|Lobster|Tangerine|Fjalla+One|Inconsolata:400,700|Yanone+Kaffeesatz|Pacifico|Oswald:300|Orbitron:900' rel='stylesheet' type='text/css'> -->
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Home &middot; Dimitris Paxinos
    
  </title> 
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/site.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png"> 
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54447083-1', 'auto');
  ga('send', 'pageview');

</script>
  <!-- <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dimitrispaxinosblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script> -->
<body>
    <div class="container content">
        <div class="masthead">
            <h3 class="masthead-title">
                <a href="/" title="Home">Dimitris Paxinos</a>
                 <!-- <small>.NET and other programming stories</small>  -->
                <ul class="menu">
                    
                    &nbsp;&nbsp;&nbsp;
                    <li><a href="/aboutme.html">About</a></li>
                    
                    &nbsp;&nbsp;&nbsp;
                    <li><a href="/archive.html">Archive</a></li>
                    
                    &nbsp;&nbsp;&nbsp;
                    <li><a href="/tags.html">Tags</a></li>
                    
                    &nbsp;&nbsp;&nbsp;
                    <li><a href="/feed.xml">Rss</a></li>
                    
                    <ul>
            </h3>
			<h3 class="masthead-title">			
			<small>.NET and other programming stories</small> 
			</h3>
        </div>

        <div class="posts">
    
	
    <div class="post">
        <h1 class="post-title">
            <a href="/blog/2014/10/One-OData-Endpoint-for-multiple-databases-with-the-same-schema">
                Web Api OData Endpoint for multiple databases with the same schema
            </a>
        </h1>
        <span class="post-date">October 10, 2014</span>
        <h2>Introduction</h2>

<p>In the .NET world, you can easily expose your database data using OData, Web Api and Entity Framework. There are many tutorials about this on <a href="http://www.asp.net">Microsoft&#39;s site</a>. Unfortunately, all the tutorials I have found online are exposing data from only one database. So, usually, you end up having an OData endpoint with a Url like this:</p>

<p><em>http://servername/OData/EntityName</em></p>

<p>What I wanted to achieve was to have one endpoint for more databases with the same schema. So the goal was to finally have a Url like this:</p>

<p><em>http://servername/OData/</em><em>DatabaseName</em><em>/EntityName</em></p>

<h2>Implementation</h2>

<p>If you like to go through the code of this example, you can find it on <a href="https://github.com/dimitrispaxinos/OData.MultipleDatabaseEndpoint"><strong>Github</strong></a>.  Our requirement is to create an endpoint in order to expose the products of a company. This company has two stores, one in Hamburg and one in Berlin with two different identical databases and we would like to be able to query the products of both databases using the same endpoint:</p>

<p><em>http://servername/OData/hamburg/Products</em></p>

<p><em>http://servername/OData/berlin/Products</em></p>

<p>This sample endpoint was created using Web API and Entity Framework as an ORM. You can modify the code accordingly in case you want to use the ORM of your choice. I also used Unity as an IOC container since dependency injection is quite crutial in this scenario. </p>

<p>We will focus on and go through the three most critical points of the implementation that have to do with:</p>

<ul>
<li>Providing the right connection string to Entity Framwork</li>
<li>Handling the provided Url, extracting the store location and routing it accordingly.</li>
<li>Unity and Object Lifetime </li>
</ul>

<h3>Connection String</h3>

<p>Our Entity Framework Context class looks like this:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductsContext</span> <span class="p">:</span> <span class="n">DbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ProductsContext</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="s">"name=HamburgDB"</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ProductsContext</span><span class="p">(</span><span class="kt">string</span> <span class="n">connectionString</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">connectionString</span><span class="p">)</span>    
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">Products</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>and is directly used by the controller in order to do all the queries. So, the information about the  connection string has to be passed to the controller and subsequently to the EF context. In order to do that, we create the following interface which is responsible for retrieving the right connection string:  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IConnectionStringProvider</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="nf">GetConnectionString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>An instance of an implementation of the above interface will be injected into the constructor of the controller every time it is instantiated using Unity. The provided connection string will be subsequently passed to the constructor of the EF context:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductsController</span> <span class="p">:</span> <span class="n">ApiController</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ProductsContext</span> <span class="n">_db</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ProductsController</span><span class="p">(</span><span class="n">IConnectionStringProvider</span> <span class="n">connectionStringProvider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_db</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProductsContext</span><span class="p">(</span><span class="n">connectionStringProvider</span><span class="p">.</span><span class="nf">GetConnectionString</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>We just saw how the connection string reaches the constructor of the EF context. Following the interface segregation principle and in order to set the connection string, we will use one more interface, the </inlinecode>IConnectionStringSetter</inlinecode> which inherits from the <inlinecode>IConnectionStringProvider</inlinecode>:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IConnectionStringSetter</span><span class="p">:</span> <span class="n">IConnectionStringProvider</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">SetConnectionString</span><span class="p">(</span><span class="kt">string</span> <span class="n">storeName</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>A simple implementation of IConnectionStringSetter would look like this:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ConnectionStringSetter</span> <span class="p">:</span> <span class="n">IConnectionStringSetter</span> 
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">StoreName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">SetConnectionString</span><span class="p">(</span><span class="kt">string</span> <span class="n">storeName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">StoreName</span> <span class="p">=</span> <span class="n">storeName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetConnectionString</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">StoreName</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>We can of course adjust the methods according to the way we set and retrieve the connection string, add validations etc.</p>

<h3>Routing</h3>

<p>We saw earlier that our goal is to have a Url that looks like this:</p>

<p><em>http://servername/OData/</em><em>DatabaseName</em><em>/EntityName</em></p>

<p>which means that we have to somehow access the Url before it is handled, extract the information we need in order to pick the right database and restore the Url to its normal form:</p>

<p><em>http://servername/OData/EntityName</em></p>

<p>This can be achieved by creating our own path handler class. This class inherits from the <inlinecode>DefaultODataPathHandler</inlinecode> class and gets an <inlinecode>IConnectionStringSetter</inlinecode>  object injected into its constructor:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomDataPathHandler</span> <span class="p">:</span> <span class="n">DefaultODataPathHandler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IConnectionStringSetter</span> <span class="n">_connectionStringSetter</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CustomDataPathHandler</span><span class="p">(</span><span class="n">IConnectionStringSetter</span> <span class="n">connectionStringSetter</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_connectionStringSetter</span> <span class="p">=</span> <span class="n">connectionStringSetter</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">ODataPath</span> <span class="nf">Parse</span><span class="p">(</span><span class="n">IEdmModel</span> <span class="n">model</span><span class="p">,</span> <span class="kt">string</span> <span class="n">odataPath</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">odataPath</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="s">"$"</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">odataPath</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">storeName</span> <span class="p">=</span> <span class="n">odataPath</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">odataPath</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="s">"/"</span><span class="p">));</span>
            <span class="n">var</span> <span class="n">entityPath</span> <span class="p">=</span> <span class="n">odataPath</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="n">odataPath</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">_connectionStringSetter</span><span class="p">.</span><span class="nf">SetConnectionString</span><span class="p">(</span><span class="n">storeName</span> <span class="p">+</span> <span class="s">"DB"</span><span class="p">);</span>
            <span class="n">odataPath</span> <span class="p">=</span> <span class="n">entityPath</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">odataPath</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Note that the <inlinecode>!odataPath.StartsWith(&quot;$&quot;)</inlinecode> part helps to avoid errors when the user requests the metadata of the endpoint like:</p>

<p><em>http://localhost:56949/odata/$metadata</em> </p>

<p>Now that we created our custom path handler, we have to register it when declaring our OData route inside the <inlinecode>Register</inlinecode> method of the static <inlinecode>WebApiConfig</inlinecode> class:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"> <span class="n">config</span><span class="p">.</span><span class="n">Routes</span><span class="p">.</span><span class="nf">MapODataRoute</span><span class="p">(</span>
        <span class="n">routeName</span><span class="p">:</span> <span class="s">"odata"</span><span class="p">,</span>
        <span class="n">routePrefix</span><span class="p">:</span> <span class="s">"odata"</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">builder</span><span class="p">.</span><span class="nf">GetEdmModel</span><span class="p">(),</span>
        <span class="n">pathHandler</span><span class="p">:</span> <span class="n">UnityConfig</span><span class="p">.</span><span class="n">UnityContainer</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">CustomDataPathHandler</span><span class="p">&gt;(),</span>
        <span class="n">routingConventions</span><span class="p">:</span> <span class="n">ODataRoutingConventions</span><span class="p">.</span><span class="nf">CreateDefault</span><span class="p">());</span>
</code></pre></div>
<p>As you can see, we use Unity to resolve our instance of <inlinecode>CustomDataPathHandler</inlinecode> because we need an <inlinecode>IConnectionStringSetter</inlinecode> object to be injected into it.</p>

<h3>Unity</h3>

<p>The last point to note is that we need to have the same object of <inlinecode>IConnectionStringSetter</inlinecode> and <inlinecode>IConnectionStringProvider</inlinecode> used by our handler and then passed to our controller. To achieve this, we register the same instance for these both interfaces in the <inlinecode>RegisterComponents</inlinecode> method of the the static <inlinecode>UnityConfig</inlinecode> class:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">var</span> <span class="n">databaseSetter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DatabaseSetter</span><span class="p">.</span><span class="nf">ConnectionStringSetter</span><span class="p">();</span>
<span class="n">UnityContainer</span><span class="p">.</span><span class="n">RegisterInstance</span><span class="p">&lt;</span><span class="n">IConnectionStringSetter</span><span class="p">&gt;(</span><span class="n">databaseSetter</span><span class="p">);</span>            <span class="n">UnityContainer</span><span class="p">.</span><span class="n">RegisterInstance</span><span class="p">&lt;</span><span class="n">IConnectionStringProvider</span><span class="p">&gt;(</span><span class="n">databaseSetter</span><span class="p">);</span>
<span class="n">UnityContainer</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">CustomDataPathHandler</span><span class="p">&gt;();</span>
</code></pre></div>
        </br>

        <ul class="tags">
            
            <li><a href="/tags/OData" class="tag" title="View posts tagged with &quot;OData&quot;">OData</a></li>
              
            <li><a href="/tags/Web Api" class="tag" title="View posts tagged with &quot;Web Api&quot;">Web Api</a></li>
              
            <li><a href="/tags/Entity Framework" class="tag" title="View posts tagged with &quot;Entity Framework&quot;">Entity Framework</a></li>
              
            <li><a href="/tags/Unity" class="tag" title="View posts tagged with &quot;Unity&quot;">Unity</a></li>
              
            <li><a href="/tags/Tutorial" class="tag" title="View posts tagged with &quot;Tutorial&quot;">Tutorial</a></li>
             
        </ul>
        </br>		
	<a href="/blog/2014/10/One-OData-Endpoint-for-multiple-databases-with-the-same-schema/#disqus_thread">Comments</a>	
	</br>
    </div>
	
    
</div>

<div>
    <ul class="pager">
		
        
        <li>
            &larr; Older
        </li>
        
        
        
        <li>
            <a href="/page6">Newer &rarr;</a>
        </li>
        
        
		 
    </ul>
</div>


        <div class="footer">
            <p>
                &copy; Dimitris Paxinos 2015. All rights reserved.
            </p>
        </div>
    </div>
	<script id="dsq-count-scr" src="//dimitrispaxinosblog.disqus.com/count.js" async></script>
</body>
</html>
